# .github/workflows/daily_validation.yml
# Milano Cortina 2026 - Daily Nationality Validation
# ===================================================
# Runs daily at 6 AM UTC during the Olympics (Feb 6-22, 2026)
# Validates athlete nationalities via Wikipedia API
# Updates Pinecone if changes detected

name: Daily Nationality Validation

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate-nationalities:
    name: Validate Athlete Nationalities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pinecone-client Wikipedia-API
      
      - name: Run nationality validation
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        run: |
          echo "Starting daily nationality validation..."
          date
          python 02_daily_validation.py
        continue-on-error: false
      
      - name: Upload validation log
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if validation found changes
        with:
          name: validation-log-${{ github.run_number }}
          path: validation_log_*.json
          retention-days: 90
      
      - name: Check for nationality changes
        id: check_changes
        run: |
          # Exit code 1 means changes detected
          if [ $? -eq 1 ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  NATIONALITY CHANGES DETECTED"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "‚úì No nationality changes - database is current"
          fi
      
      - name: Create issue if changes detected
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Parse validation log to get confidence level
            const fs = require('fs');
            const logFiles = fs.readdirSync('.').filter(f => f.startsWith('validation_log_'));
            let confidenceLevel = 'unknown';
            let needsReview = false;
            
            if (logFiles.length > 0) {
              const logData = JSON.parse(fs.readFileSync(logFiles[0], 'utf8'));
              if (logData.nationality_changes && logData.nationality_changes.length > 0) {
                confidenceLevel = logData.nationality_changes[0].confidence || 'medium';
                needsReview = logData.validation_results.some(r => r.needs_manual_review);
              }
            }
            
            const labels = ['data-validation'];
            let title = '‚ö†Ô∏è Athlete Nationality Changes Detected';
            let urgency = '';
            
            if (needsReview || confidenceLevel === 'low') {
              labels.push('needs-manual-review', 'high-priority');
              title = 'üö® Low-Confidence Nationality Change - Manual Review Required';
              urgency = `\n\n‚ö†Ô∏è **IMPORTANT:** This change has LOW confidence. Wikipedia data may be incorrect or ambiguous. **DO NOT assume the change is valid.** Review carefully before accepting.\n`;
            } else if (confidenceLevel === 'medium') {
              labels.push('needs-verification');
              urgency = `\n\n**Note:** This change has MEDIUM confidence. Wikipedia mentions a different country, but it's not completely clear. Review within 24 hours to confirm.\n`;
            } else {
              labels.push('auto-approved');
              urgency = `\n\n‚úì This change has HIGH confidence and was auto-applied. Wikipedia clearly lists the new nationality. Review for records but likely accurate.\n`;
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## Nationality Validation Alert
              ${urgency}
              The daily validation run on ${new Date().toISOString()} detected athlete nationality changes.
              
              **Confidence Level:** ${confidenceLevel.toUpperCase()}
              **Status:** ${needsReview ? 'Awaiting Manual Review' : 'Auto-Updated'}
              
              **Action Required:**
              1. Download the validation log artifact from this workflow run
              2. Review the changes in \`nationality_changes\` section
              3. ${needsReview ? 'Manually update Pinecone if Wikipedia is correct, or revert if Wikipedia is wrong' : 'Verify the changes are legitimate'}
              4. Close this issue once reviewed
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              <details>
              <summary>What this means</summary>
              
              An athlete's nationality has changed since the last validation. This could be:
              - Athlete switched countries (rare but happens in Olympics)
              - Wikipedia data was updated
              - ROC/Russia status change
              - Wikipedia vandalism or error (check confidence level!)
              
              ${needsReview ? 
                'The Pinecone database was NOT automatically updated due to low confidence. You must review and update manually if needed.' : 
                'The Pinecone database has been automatically updated. Tyler/Sasha commentary will now use the correct nationality.'}
              </details>
              
              <details>
              <summary>Confidence Levels Explained</summary>
              
              - **HIGH**: Country clearly mentioned in first 500 characters of Wikipedia summary ‚Üí Auto-update safe
              - **MEDIUM**: Different country found in Wikipedia but not immediately clear ‚Üí Auto-updated but verify
              - **LOW**: Country not found or ambiguous ‚Üí Pinecone NOT updated, manual review required
              </details>
              `,
              labels: labels
            })

# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
# 
# 1. Add this file to your repo:
#    milan-olympics-chatbot/.github/workflows/daily_validation.yml
#
# 2. Add secret to GitHub:
#    - Go to: Settings > Secrets and variables > Actions
#    - Click "New repository secret"
#    - Name: PINECONE_API_KEY
#    - Value: [your Pinecone API key]
#    - Click "Add secret"
#
# 3. Enable workflow:
#    - Go to: Actions tab
#    - Find "Daily Nationality Validation" workflow
#    - Click "Enable workflow" (if disabled)
#
# 4. Test manual run:
#    - Go to: Actions > Daily Nationality Validation
#    - Click "Run workflow" > "Run workflow"
#    - Check the run for any errors
#    - Download the validation log artifact
#
# 5. Schedule will run automatically:
#    - Daily at 6 AM UTC starting Feb 6, 2026
#    - You can pause/disable in Actions tab if needed
#
# ============================================================================
# PACKAGE NAMES (IMPORTANT)
# ============================================================================
#
# Install: pip install Wikipedia-API (with capital W and hyphen)
# Import:  import wikipediaapi (lowercase, no hyphen)
#
# This is correct! The PyPI package name and Python import name are different.
#
# ============================================================================
